# ==============================================
# Stalwart Advanced Setup - Environment Variables
# ==============================================
# This file contains ALL required variables for docker-compose.advanced.yml
# with separate admin and mail domains using nginx reverse proxy
#
# Quick password generation:
# openssl rand -base64 32
#
# Copy this file to .env and customize:
# cp .env.example .env
# nano .env
# ==============================================

# ==============================================
# REQUIRED: Admin Credentials
# ==============================================
# Admin password for Stalwart web interface
# Access via: https://admin.yourdomain.com (after nginx setup)
# Login with: admin / YOUR_ADMIN_SECRET
# SECURITY: Replace with a strong password!
# Generate with: openssl rand -base64 32
ADMIN_SECRET=REPLACE_WITH_STRONG_RANDOM_PASSWORD

# ==============================================
# REQUIRED: Domain Configuration
# ==============================================
# Mail services domain (SMTP, IMAP, POP3, ManageSieve)
# This domain will use Stalwart's built-in ACME for TLS
# Configure ACME in admin dashboard: Settings → TLS → ACME
MAIL_DOMAIN=mail.example.com

# Admin panel domain (accessed via nginx reverse proxy)
# This domain requires TLS certificates (certbot or manual)
# See nginx/README.md for certificate setup instructions
ADMIN_DOMAIN=admin.example.com

# ==============================================
# Database Configuration
# ==============================================
# PostgreSQL database password
# SECURITY: Replace with a strong password!
# Generate with: openssl rand -base64 32
DB_PASSWORD=REPLACE_WITH_STRONG_RANDOM_PASSWORD

# ==============================================
# Cache Configuration
# ==============================================
# Redis cache password
# SECURITY: Replace with a strong password!
# Generate with: openssl rand -base64 32
REDIS_PASSWORD=REPLACE_WITH_STRONG_RANDOM_PASSWORD

# ==============================================
# Object Storage Configuration
# ==============================================
# MinIO S3-compatible storage credentials
MINIO_USER=minioadmin
# SECURITY: Replace with a strong password!
# Generate with: openssl rand -base64 32
MINIO_PASSWORD=REPLACE_WITH_STRONG_RANDOM_PASSWORD

# ==============================================
# System Configuration
# ==============================================
# Server timezone (examples: UTC, America/New_York, Europe/London, Asia/Tokyo)
TZ=UTC

# ==============================================
# Resource Configuration
# ==============================================
# These are MINIMUM guaranteed resources (soft limits)
# Containers can use MORE when needed (dynamic allocation)

# Stalwart Mail Server
STALWART_MEMORY_RESERVATION=1G
STALWART_CPU_RESERVATION=1

# PostgreSQL Database
POSTGRES_MEMORY_RESERVATION=512M
POSTGRES_CPU_RESERVATION=0.5

# Redis Cache
REDIS_MEMORY_RESERVATION=256M
REDIS_CPU_RESERVATION=0.25

# MinIO Object Storage
MINIO_MEMORY_RESERVATION=512M
MINIO_CPU_RESERVATION=0.5

# ==============================================
# Optional: Hard Limits (Uncomment to Cap Usage)
# ==============================================
# Uncomment these if you want to PREVENT containers from using too much
# By default, containers can use as much as they need (dynamic allocation)
#
# STALWART_MEMORY_LIMIT=4G
# STALWART_CPU_LIMIT=4
# POSTGRES_MEMORY_LIMIT=2G
# REDIS_MEMORY_LIMIT=1G
# MINIO_MEMORY_LIMIT=2G

# ==============================================
# DEPLOYMENT INSTRUCTIONS
# ==============================================
# 
# 1. GENERATE SECURE PASSWORDS
#    Run these commands and paste the output above:
#    echo "ADMIN_SECRET=$(openssl rand -base64 32)"
#    echo "DB_PASSWORD=$(openssl rand -base64 32)"
#    echo "REDIS_PASSWORD=$(openssl rand -base64 32)"
#    echo "MINIO_PASSWORD=$(openssl rand -base64 32)"
#
# 2. CONFIGURE DOMAINS
#    Replace mail.example.com and admin.example.com with your actual domains
#    Both domains must point to your server's IP address (DNS A records)
#
# 3. SETUP NGINX CERTIFICATES (for admin domain)
#    Option A - Certbot (recommended):
#      mkdir -p nginx/webroot
#      sudo certbot certonly --webroot -w ./nginx/webroot -d admin.example.com
#      # Update nginx/conf.d/admin.conf to use Let's Encrypt paths
#    
#    Option B - Manual certificates:
#      mkdir -p nginx/certs
#      cp fullchain.pem nginx/certs/admin.example.com.crt
#      cp privkey.pem nginx/certs/admin.example.com.key
#      chmod 644 nginx/certs/*.crt
#      chmod 600 nginx/certs/*.key
#
# 4. UPDATE NGINX CONFIGURATION
#    Edit nginx/conf.d/admin.conf and replace admin.example.com with your domain
#
# 5. SECURE THIS FILE
#    chmod 600 .env
#    chown $USER:$USER .env
#
# 6. DEPLOY
#    docker compose -f docker-compose.advanced.yml up -d --build
#
# 7. CONFIGURE STALWART ACME (for mail domain TLS)
#    - Access admin panel: https://admin.yourdomain.com
#    - Login: admin / YOUR_ADMIN_SECRET
#    - Navigate: Settings → TLS → ACME
#    - Enable ACME for mail.yourdomain.com
#    - Stalwart will automatically obtain and renew mail TLS certificates
#
# 8. VERIFY DEPLOYMENT
#    docker compose -f docker-compose.advanced.yml ps
#    docker compose -f docker-compose.advanced.yml logs -f
#    curl -I https://admin.yourdomain.com
#    telnet mail.yourdomain.com 25
#
# ==============================================
# DNS CONFIGURATION REQUIRED
# ==============================================
# Configure these DNS records for your domain:
#
# A Records:
#   mail.example.com      A      YOUR_SERVER_IP
#   admin.example.com     A      YOUR_SERVER_IP
#   example.com           A      YOUR_SERVER_IP
#
# MX Record (for receiving email):
#   example.com           MX 10  mail.example.com
#
# SPF Record (recommended):
#   example.com           TXT    "v=spf1 mx ~all"
#
# DMARC Record (recommended):
#   _dmarc.example.com    TXT    "v=DMARC1; p=quarantine; rua=mailto:dmarc@example.com"
#
# Note: DKIM will be configured in Stalwart admin dashboard
#
# ==============================================
# SECURITY NOTES
# ==============================================
# 1. NEVER use example passwords in production!
# 2. Generate strong passwords: openssl rand -base64 32
# 3. Set file permissions: chmod 600 .env
# 4. NEVER commit .env to version control (check .gitignore)
# 5. Use secrets management in production (Vault, AWS Secrets Manager, etc.)
# 6. Rotate passwords regularly (at least every 90 days)
# 7. Use different passwords for each service
# 8. Monitor access logs regularly
#
# ==============================================
# PORTS USED
# ==============================================
# External (accessible from internet):
#   80    - HTTP (nginx - redirects to HTTPS)
#   443   - HTTPS (nginx - admin panel)
#   25    - SMTP (Stalwart - incoming mail)
#   587   - Submission (Stalwart - authenticated sending)
#   465   - Submissions (Stalwart - SMTP over TLS)
#   143   - IMAP (Stalwart - email access)
#   993   - IMAPS (Stalwart - IMAP over TLS)
#   110   - POP3 (Stalwart - email access)
#   995   - POP3S (Stalwart - POP3 over TLS)
#   4190  - ManageSieve (Stalwart - filter management)
#
# Internal (localhost only):
#   8080  - Stalwart admin (accessed via nginx)
#   9001  - MinIO console (web UI)
#
# ==============================================
# TROUBLESHOOTING
# ==============================================
# 
# Service won't start:
#   docker compose -f docker-compose.advanced.yml logs SERVICE_NAME
#
# Check all services status:
#   docker compose -f docker-compose.advanced.yml ps
#
# Test nginx configuration:
#   docker compose exec nginx nginx -t
#
# Test database connection:
#   docker compose exec postgres psql -U stalwart -d stalwart -c "SELECT 1;"
#
# Test Redis connection:
#   docker compose exec redis redis-cli -a YOUR_REDIS_PASSWORD ping
#
# View real-time logs:
#   docker compose -f docker-compose.advanced.yml logs -f
#
# Restart a service:
#   docker compose -f docker-compose.advanced.yml restart SERVICE_NAME
#
# ==============================================
# DOCUMENTATION
# ==============================================
# Complete guides:
#   - MULTI_SERVICE_SETUP.md - Comprehensive deployment guide
#   - nginx/README.md - nginx configuration and TLS setup
#   - CHANGES_SUMMARY.md - Recent changes and architecture
#
# Stalwart documentation:
#   https://stalw.art/docs
# ==============================================
