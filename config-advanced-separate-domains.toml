#############################################
# Stalwart Advanced Configuration
# Separate Domains Setup
# Mail: mail.yourdomain.com
# Admin: admin.yourdomain.com (via Caddy reverse proxy)
# 
# This configuration uses:
# - PostgreSQL for data and full-text search
# - Redis for caching and lookups
# - S3 (MinIO) for blob storage
# - Separate admin domain for security
#############################################

# ==============================================
# Server Configuration
# ==============================================

[server]
hostname = "%{env:MAIL_DOMAIN}%"

# ==============================================
# Server Listeners
# ==============================================

# SMTP Listeners - Direct access on mail domain
[server.listener."smtp"]
bind = ["0.0.0.0:25"]
protocol = "smtp"

[server.listener."submission"]
bind = ["0.0.0.0:587"]
protocol = "smtp"

[server.listener."submissions"]
bind = ["0.0.0.0:465"]
protocol = "smtp"
tls.implicit = true

# IMAP Listeners - Direct access on mail domain
[server.listener."imap"]
bind = ["0.0.0.0:143"]
protocol = "imap"

[server.listener."imaptls"]
bind = ["0.0.0.0:993"]
protocol = "imap"
tls.implicit = true

# POP3 Listeners - Direct access on mail domain
[server.listener."pop3"]
bind = ["0.0.0.0:110"]
protocol = "pop3"

[server.listener."pop3s"]
bind = ["0.0.0.0:995"]
protocol = "pop3"
tls.implicit = true

# ManageSieve Listener - Direct access
[server.listener."sieve"]
bind = ["0.0.0.0:4190"]
protocol = "managesieve"

# HTTP Admin Interface - localhost only (accessed via Caddy reverse proxy)
# Admin domain: admin.yourdomain.com (handled by Caddy)
[server.listener."http-admin"]
bind = ["127.0.0.1:8080"]
protocol = "http"
# Note: TLS termination handled by Caddy reverse proxy
# Caddy will forward admin.yourdomain.com to this localhost:8080 endpoint

# ==============================================
# Storage Configuration
# ==============================================

[storage]
# Use PostgreSQL for data and full-text search
data = "postgres"
fts = "postgres"

# Use S3 (MinIO) for blob storage (attachments, large files)
blob = "s3"

# Use Redis for lookups (caching)
lookup = "redis"

# Use internal directory backed by PostgreSQL
directory = "internal"

# ==============================================
# PostgreSQL Store
# ==============================================

[store."postgres"]
type = "postgresql"
host = "%{env:DB_HOST}%"
port = "%{env:DB_PORT}%"
database = "%{env:DB_NAME}%"
user = "%{env:DB_USER}%"
password = "%{env:DB_PASSWORD}%"

# Connection pool settings
pool.max-connections = 10
pool.min-connections = 5
pool.max-lifetime = "30m"

# ==============================================
# S3 (MinIO) Store for Blobs
# ==============================================

[store."s3"]
type = "s3"
endpoint = "%{env:S3_ENDPOINT}%"
bucket = "%{env:S3_BUCKET}%"
region = "%{env:S3_REGION}%"
access-key = "%{env:S3_ACCESS_KEY}%"
secret-key = "%{env:S3_SECRET_KEY}%"

# Optional: Enable path-style addressing for MinIO
# path-style = true

# ==============================================
# Redis Store for Caching
# ==============================================

[store."redis"]
type = "redis"
urls = ["redis://:%{env:REDIS_PASSWORD}%@%{env:REDIS_HOST}%:%{env:REDIS_PORT}%"]

# Connection pool settings
pool.max-connections = 10

# ==============================================
# Directory Configuration
# ==============================================

[directory."internal"]
type = "internal"
store = "postgres"

# ==============================================
# Authentication
# ==============================================

[authentication.fallback-admin]
user = "admin"
secret = "%{env:ADMIN_SECRET}%"

# ==============================================
# Logging and Tracing
# ==============================================

[tracer."stdout"]
type = "stdout"
level = "info"
ansi = false
enable = true

# Optional: Enable detailed logging
# [tracer."stdout"]
# level = "debug"

# ==============================================
# TLS Configuration (Optional)
# ==============================================

# For production mail services, configure proper TLS certificates
# Note: Admin panel TLS is handled by Caddy reverse proxy
# [server.tls]
# certificate = "/path/to/mail-cert.pem"
# private-key = "/path/to/mail-key.pem"

# Or use ACME (Let's Encrypt) for automatic certificates on mail domain
# [acme]
# directory = "https://acme-v02.api.letsencrypt.org/directory"
# contact = ["mailto:admin@example.com"]

# ==============================================
# Spam Filter Configuration (Optional)
# ==============================================

[spam-filter]
enable = true

# ==============================================
# DKIM Signing (Optional)
# ==============================================

# [dkim."example.com"]
# domain = "example.com"
# selector = "default"
# private-key = "/path/to/dkim.key"

# ==============================================
# SMTP Server Configuration
# ==============================================

[smtp.server]
hostname = "%{env:MAIL_DOMAIN}%"
greeting = "Stalwart SMTP Server"

# ==============================================
# Queue Configuration
# ==============================================

[smtp.queue]
# Retry schedule
retry = ["2m", "5m", "10m", "30m", "1h", "2h", "6h", "12h"]

# ==============================================
# Rate Limiting (Optional)
# ==============================================

# [rate-limit."smtp"]
# rate = "10/1m"

# ==============================================
# Configuration Notes
# ==============================================

# This configuration implements separate domains for security:
#
# 1. Mail Domain (mail.yourdomain.com):
#    - All mail services (SMTP, IMAP, POP3, ManageSieve)
#    - Direct access on standard ports
#    - Can use TLS directly or via Let's Encrypt ACME
#
# 2. Admin Domain (admin.yourdomain.com):
#    - Admin panel accessed via Caddy reverse proxy
#    - Automatic HTTPS with Let's Encrypt via Caddy
#    - Bound to localhost only (127.0.0.1:8080)
#    - Additional security headers from Caddy
#    - Isolated from mail infrastructure
#
# Environment Variables Required:
# - ADMIN_SECRET: Admin password
# - MAIL_DOMAIN: Mail server domain (e.g., mail.yourdomain.com)
# - ADMIN_DOMAIN: Admin panel domain (e.g., admin.yourdomain.com)
# - DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD: PostgreSQL connection
# - REDIS_HOST, REDIS_PORT, REDIS_PASSWORD: Redis connection
# - S3_ENDPOINT, S3_BUCKET, S3_REGION, S3_ACCESS_KEY, S3_SECRET_KEY: MinIO/S3
#
# Security Benefits:
# ✓ Admin panel not directly exposed to internet
# ✓ Admin accessed only via reverse proxy with HTTPS
# ✓ Clear separation between mail and admin
# ✓ Automatic certificate management for admin
# ✓ Additional security headers from reverse proxy
# ✓ Professional domain structure
# ✓ Internal services (DB, Redis, MinIO) on private network
#
# For complete setup instructions, see:
# - MULTI_SERVICE_SETUP.md
# - SEPARATE_DOMAINS_SETUP.md
#
# For configuration options reference:
# https://stalw.art/docs/configuration
