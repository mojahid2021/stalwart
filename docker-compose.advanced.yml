# Advanced Stalwart Docker Compose Configuration
# This setup includes PostgreSQL, Redis, and MinIO (S3-compatible storage)
# for a production-ready deployment with external services

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: stalwart-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: stalwart
      POSTGRES_USER: stalwart
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD required}
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stalwart"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: stalwart-redis
    restart: unless-stopped
    
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
    
    volumes:
      - redis-data:/data
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD", "redis-cli", "--askpass", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # MinIO (S3-Compatible Object Storage)
  minio:
    image: minio/minio:latest
    container_name: stalwart-minio
    restart: unless-stopped
    
    command: server /data --console-address ":9001"
    
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:?MINIO_PASSWORD required}
    
    volumes:
      - minio-data:/data
    
    ports:
      # MinIO API port (internal use)
      - "9000:9000"
      # MinIO Console (web UI)
      - "9001:9001"
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  # MinIO Client - Initialize bucket (runs once)
  minio-init:
    image: minio/mc:latest
    container_name: stalwart-minio-init
    depends_on:
      minio:
        condition: service_healthy
    
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_USER:-minioadmin} ${MINIO_PASSWORD} &&
      /usr/bin/mc mb myminio/stalwart-blobs --ignore-existing &&
      /usr/bin/mc anonymous set download myminio/stalwart-blobs &&
      echo 'MinIO bucket initialized successfully'
      "
    
    networks:
      - stalwart-net

  # Stalwart Mail Server
  stalwart:
    build:
      context: .
      dockerfile: Dockerfile
    image: stalwart:local
    container_name: stalwart
    hostname: mail.example.com
    restart: unless-stopped
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    
    ports:
      # SMTP ports
      - "25:25"      # SMTP (Mail Transfer Agent)
      - "587:587"    # Submission (Mail Submission Agent)
      - "465:465"    # Submissions (Submission over TLS)
      
      # IMAP ports
      - "143:143"    # IMAP
      - "993:993"    # IMAPS (IMAP over TLS)
      
      # POP3 ports
      - "110:110"    # POP3
      - "995:995"    # POP3S (POP3 over TLS)
      
      # Additional services
      - "4190:4190"  # ManageSieve
      - "8080:8080"  # HTTP Admin Interface
      - "443:443"    # HTTPS Admin Interface
    
    volumes:
      # Persistent configuration and logs
      - ./stalwart-data:/opt/stalwart
      
      # Optional: Mount custom configuration file
      # Uncomment the line below and create config-advanced.toml
      # - ./config-advanced.toml:/opt/stalwart/etc/config.toml:ro
    
    environment:
      # Admin credentials
      - ADMIN_SECRET=${ADMIN_SECRET:?ADMIN_SECRET required}
      
      # Stalwart paths
      - STALWART_PATH=/opt/stalwart
      
      # PostgreSQL connection
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=stalwart
      - DB_USER=stalwart
      - DB_PASSWORD=${DB_PASSWORD}
      
      # Redis connection
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # MinIO/S3 connection
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=stalwart-blobs
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=${MINIO_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_PASSWORD}
      
      # System settings
      - TZ=${TZ:-UTC}
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    networks:
      - stalwart-net
    
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'
        reservations:
          memory: 1G
          cpus: '1'
    
    # Optional: Enable logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  stalwart-net:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local

# To use this file:
# 
# 1. Create a .env file with the following content:
#    ADMIN_SECRET=your-secure-admin-password
#    DB_PASSWORD=your-secure-db-password
#    REDIS_PASSWORD=your-secure-redis-password
#    MINIO_PASSWORD=your-secure-minio-password
#    TZ=UTC
#
# 2. Build and start all services:
#    docker-compose -f docker-compose.advanced.yml up -d --build
#
# 3. Monitor logs:
#    docker-compose -f docker-compose.advanced.yml logs -f
#
# 4. Access services:
#    - Stalwart Admin: http://localhost:8080 (admin / your-admin-password)
#    - MinIO Console: http://localhost:9001 (minioadmin / your-minio-password)
#
# 5. Stop services:
#    docker-compose -f docker-compose.advanced.yml down
#
# 6. Remove all data (WARNING: This deletes everything):
#    docker-compose -f docker-compose.advanced.yml down -v
#
# Note: For production use, you'll need to create a custom configuration file
# (config-advanced.toml) that uses PostgreSQL, Redis, and S3 storage backends.
# See SETUP.md for configuration examples.
