# Advanced Stalwart Docker Compose Configuration
# This setup includes PostgreSQL, Redis, MinIO, and nginx reverse proxy
# for a production-ready deployment with separate admin and mail domains
#
# ðŸ“š Complete Guide: See MULTI_SERVICE_SETUP.md for detailed documentation
#
# Architecture:
# - Mail services: mail.yourdomain.com (with Stalwart's built-in ACME TLS)
# - Admin panel: admin.yourdomain.com (via nginx reverse proxy)
# - Internal services: PostgreSQL, Redis, MinIO (isolated network)
#
# Quick Start:
# 1. Copy .env.example to .env and set secure passwords + domains
# 2. Configure nginx: Place your nginx config in nginx/conf.d/
# 3. Run: docker compose -f docker-compose.advanced.yml up -d --build
# 4. Access Admin: https://admin.yourdomain.com (via nginx)
# 5. Mail TLS: Configure ACME in Stalwart admin dashboard

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: stalwart-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: stalwart
      POSTGRES_USER: stalwart
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD required}
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stalwart"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # Resource configuration (dynamic allocation)
    deploy:
      resources:
        reservations:
          memory: ${POSTGRES_MEMORY_RESERVATION:-512M}
          cpus: '${POSTGRES_CPU_RESERVATION:-0.5}'

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: stalwart-redis
    restart: unless-stopped
    
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
    
    volumes:
      - redis-data:/data
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # Resource configuration (dynamic allocation)
    deploy:
      resources:
        reservations:
          memory: ${REDIS_MEMORY_RESERVATION:-256M}
          cpus: '${REDIS_CPU_RESERVATION:-0.25}'

  # MinIO (S3-Compatible Object Storage)
  minio:
    image: minio/minio:latest
    container_name: stalwart-minio
    restart: unless-stopped
    
    command: server /data --console-address ":9001"
    
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:?MINIO_PASSWORD required}
    
    volumes:
      - minio-data:/data
    
    ports:
      # MinIO Console (web UI) - localhost only for security
      - "127.0.0.1:9001:9001"
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    # Resource configuration (dynamic allocation)
    deploy:
      resources:
        reservations:
          memory: ${MINIO_MEMORY_RESERVATION:-512M}
          cpus: '${MINIO_CPU_RESERVATION:-0.5}'

  # MinIO Client - Initialize bucket (runs once)
  minio-init:
    image: minio/mc:latest
    container_name: stalwart-minio-init
    depends_on:
      minio:
        condition: service_healthy
    
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_USER:-minioadmin} ${MINIO_PASSWORD} &&
      /usr/bin/mc mb myminio/stalwart-blobs --ignore-existing &&
      /usr/bin/mc anonymous set download myminio/stalwart-blobs &&
      echo 'MinIO bucket initialized successfully'
      "
    
    networks:
      - stalwart-net

  # Stalwart Mail Server
  stalwart:
    build:
      context: .
      dockerfile: Dockerfile
    image: stalwart:local
    container_name: stalwart
    hostname: ${MAIL_DOMAIN:-mail.example.com}
    restart: unless-stopped
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    
    ports:
      # SMTP ports
      - "25:25"      # SMTP (Mail Transfer Agent)
      - "587:587"    # Submission (Mail Submission Agent)
      - "465:465"    # Submissions (Submission over TLS)
      
      # IMAP ports
      - "143:143"    # IMAP
      - "993:993"    # IMAPS (IMAP over TLS)
      
      # POP3 ports
      - "110:110"    # POP3
      - "995:995"    # POP3S (POP3 over TLS)
      
      # Additional services
      - "4190:4190"  # ManageSieve
      
      # Admin Interface - localhost only (accessed via nginx reverse proxy)
      - "127.0.0.1:8080:8080"  # HTTP Admin Interface (internal only)
    
    volumes:
      # Persistent configuration and logs
      - ./stalwart-data:/opt/stalwart
      
      # Mount custom configuration file for advanced setup with separate domains
      - ./config-advanced.toml:/opt/stalwart/etc/config.toml:ro
    
    environment:
      # Admin credentials
      - ADMIN_SECRET=${ADMIN_SECRET:?ADMIN_SECRET required}
      
      # Stalwart paths
      - STALWART_PATH=/opt/stalwart
      
      # Domain configuration
      - MAIL_DOMAIN=${MAIL_DOMAIN:-mail.example.com}
      - ADMIN_DOMAIN=${ADMIN_DOMAIN:-admin.example.com}
      
      # PostgreSQL connection
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=stalwart
      - DB_USER=stalwart
      - DB_PASSWORD=${DB_PASSWORD}
      
      # Redis connection
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # MinIO/S3 connection
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=stalwart-blobs
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=${MINIO_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_PASSWORD}
      
      # System settings
      - TZ=${TZ:-UTC}
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    networks:
      - stalwart-net
    
    # Resource configuration (dynamic allocation by default)
    # Docker will use what it needs without hard limits
    deploy:
      resources:
        # Soft limits (reservations) - minimum guaranteed resources
        reservations:
          memory: ${STALWART_MEMORY_RESERVATION:-1G}
          cpus: '${STALWART_CPU_RESERVATION:-1}'
    
    # Optional: Enable logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy (Admin Panel)
  nginx:
    image: nginx:alpine
    container_name: stalwart-nginx
    restart: unless-stopped
    
    depends_on:
      stalwart:
        condition: service_healthy
    
    ports:
      # HTTP and HTTPS for admin domain
      - "80:80"      # HTTP (for ACME challenge and redirect)
      - "443:443"    # HTTPS (admin panel)
    
    volumes:
      # Nginx configuration
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # TLS certificates (managed manually or via certbot)
      - ./nginx/certs:/etc/nginx/certs:ro
      # Nginx logs
      - nginx-logs:/var/log/nginx
    
    networks:
      - stalwart-net
    
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  stalwart-net:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
  nginx-logs:
    driver: local

# ==============================================================================
# USAGE INSTRUCTIONS
# ==============================================================================
#
# 1. SETUP ENVIRONMENT FILE
#    Copy .env.example to .env and customize:
#    cp .env.example .env
#    nano .env
#
#    Required variables:
#    - ADMIN_SECRET=your-secure-admin-password
#    - DB_PASSWORD=your-secure-db-password
#    - REDIS_PASSWORD=your-secure-redis-password
#    - MINIO_PASSWORD=your-secure-minio-password
#    - MAIL_DOMAIN=mail.yourdomain.com
#    - ADMIN_DOMAIN=admin.yourdomain.com
#    - TZ=UTC
#
# 2. CONFIGURE NGINX
#    Create nginx configuration:
#    mkdir -p nginx/conf.d nginx/certs
#    
#    Create nginx/nginx.conf (basic config)
#    Create nginx/conf.d/admin.conf (admin domain config)
#    See MULTI_SERVICE_SETUP.md for nginx configuration examples
#
# 3. CONFIGURE DNS
#    Point both domains to your server IP:
#    - mail.yourdomain.com    A    YOUR_SERVER_IP
#    - admin.yourdomain.com   A    YOUR_SERVER_IP
#    - yourdomain.com         MX   mail.yourdomain.com
#
# 4. SETUP TLS CERTIFICATES
#    For admin.yourdomain.com (nginx):
#    - Use certbot: certbot certonly --nginx -d admin.yourdomain.com
#    - Or place manual certs in nginx/certs/
#    
#    For mail.yourdomain.com (Stalwart built-in ACME):
#    - Configure in Stalwart admin dashboard after deployment
#    - Settings â†’ TLS â†’ ACME â†’ Enable Let's Encrypt
#
# 5. BUILD AND START
#    docker compose -f docker-compose.advanced.yml up -d --build
#
# 6. CONFIGURE STALWART ACME (for mail domain TLS)
#    - Access admin panel: https://admin.yourdomain.com
#    - Navigate to Settings â†’ TLS
#    - Enable ACME for mail.yourdomain.com
#    - Stalwart will automatically obtain and renew certificates
#
# 7. MONITOR LOGS
#    docker compose -f docker-compose.advanced.yml logs -f
#
# 8. ACCESS SERVICES
#    - Admin Panel: https://admin.yourdomain.com (via nginx)
#    - Mail Server: mail.yourdomain.com (for email clients, with ACME TLS)
#    - MinIO Console: http://localhost:9001 (local only)
#
# 9. STOP SERVICES
#    docker compose -f docker-compose.advanced.yml down
#
# 10. REMOVE ALL DATA (WARNING: Deletes everything)
#     docker compose -f docker-compose.advanced.yml down -v
#
# ==============================================================================
# SECURITY FEATURES
# ==============================================================================
#
# âœ“ Admin panel bound to localhost, accessed via nginx reverse proxy
# âœ“ Mail domain uses Stalwart's built-in ACME for automatic TLS
# âœ“ Admin domain uses nginx with manual TLS or certbot
# âœ“ Internal services (PostgreSQL, Redis, MinIO) on private network
# âœ“ MinIO console restricted to localhost
# âœ“ Separate domains for mail and admin (professional setup)
#
# ==============================================================================
# COMPLETE DOCUMENTATION
# ==============================================================================
#
# ðŸ“š See MULTI_SERVICE_SETUP.md for:
#    - Complete nginx configuration examples
#    - Detailed setup instructions
#    - Stalwart ACME configuration guide
#    - Troubleshooting common issues
#    - Production deployment best practices
#    - Backup and restore procedures
#    - Scaling strategies
#    - Security hardening
#    - Monitoring and health checks
#
# ==============================================================================
