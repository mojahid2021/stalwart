# Caddy Configuration for Stalwart Admin Panel
# Automatic HTTPS with Let's Encrypt
#
# This configuration:
# - Serves admin panel on admin.yourdomain.com
# - Automatically obtains and renews TLS certificates
# - Adds security headers
# - Proxies to Stalwart container on localhost:8080

# Global options
{
    # Email for Let's Encrypt notifications (certificate expiration, etc.)
    email {$ACME_EMAIL}
    
    # Enable admin API for health checks (optional)
    admin :2019
    
    # Automatic HTTPS
    auto_https on
}

# Admin panel - admin.yourdomain.com
{$ADMIN_DOMAIN} {
    # Reverse proxy to Stalwart admin interface
    reverse_proxy stalwart:8080 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s
        
        # Proper headers for proxy
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Security headers
    header {
        # Strict Transport Security (HSTS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Prevent clickjacking
        X-Frame-Options "DENY"
        
        # XSS Protection (legacy browsers)
        X-XSS-Protection "1; mode=block"
        
        # Content Security Policy (adjust as needed)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"
        
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions Policy
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
        
        # Remove server identification
        -Server
    }
    
    # Access logging (using stdout for Docker)
    log {
        output stdout
        format json
        level INFO
    }
    
    # Error logging
    handle_errors {
        @5xx expression `{http.error.status_code} >= 500`
        handle @5xx {
            respond "Service temporarily unavailable" 503
        }
        
        @4xx expression `{http.error.status_code} >= 400 && {http.error.status_code} < 500`
        handle @4xx {
            respond "Resource not found or access denied" {http.error.status_code}
        }
    }
}

# Optional: Health check endpoint for monitoring
# Uncomment if you want a separate health check URL
# health.{$ADMIN_DOMAIN} {
#     respond /health 200 {
#         body "OK"
#     }
# }

# ==============================================================================
# CONFIGURATION NOTES
# ==============================================================================
#
# Environment Variables (set in docker-compose or .env):
# - ADMIN_DOMAIN: The domain for admin panel (e.g., admin.yourdomain.com)
# - ACME_EMAIL: Email for Let's Encrypt notifications (e.g., admin@yourdomain.com)
#
# DNS Requirements:
# - admin.yourdomain.com must point to your server's public IP
# - Port 80 must be accessible for ACME challenge
# - Port 443 must be accessible for HTTPS traffic
#
# Testing:
# 1. Test configuration: docker exec stalwart-caddy caddy validate --config /etc/caddy/Caddyfile
# 2. Reload configuration: docker exec stalwart-caddy caddy reload --config /etc/caddy/Caddyfile
# 3. Check logs: docker logs stalwart-caddy
#
# Security Features:
# - Automatic HTTPS with Let's Encrypt
# - HSTS with preload support
# - Comprehensive security headers
# - Protection against common vulnerabilities
# - JSON access logs for monitoring
# - Proper error handling
#
# Customization:
# - Adjust Content-Security-Policy if admin panel uses external resources
# - Add rate limiting if needed (see Caddy documentation)
# - Configure custom error pages if desired
# - Add IP whitelisting for additional security
#
# ==============================================================================
